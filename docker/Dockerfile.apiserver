FROM node:14.7.0-alpine3.12 AS builder
RUN apk --no-cache add yarn curl
WORKDIR /app

RUN mkdir /build
COPY package.json package-lock.json /build/
WORKDIR /build
RUN yarn install --production=true && \
  curl -sf https://gobinaries.com/tj/node-prune | sh
COPY . .
RUN mv ormconfig_postgres.json ormconfig.json

RUN yarn compile && \
  rm -rf /usr/local/share/.cache/yarn && \
  rm -rf /app/node_modules/typescript && \
  rm -rf /app/node_modules/prettier

RUN node-prune && \
  rm -rf ./node_modules/eslint && \
  rm -rf ./node_modules/@types && \
  rm -rf ./coverage && \
  rm -rf node_modules/rxjs/src/ && \
  rm -rf node_modules/rxjs/bundles/ && \
  rm -rf node_modules/rxjs/_esm5/ && \
  rm -rf node_modules/rxjs/_esm2015/ && \
  rm -rf node_modules/grpc/deps/grpc/third_party/ && \
  rm -rf node_modules/aws-sdk/dist/

FROM node:14.7.0-alpine3.12
RUN apk --no-cache add --update yarn curl
COPY --from=builder /build/ /app/

WORKDIR /app

#RUN echo "changed"
# TOOD: Change to production cmd.
CMD ["yarn", "debug"]
